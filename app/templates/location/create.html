{% extends "layouts/base.html" %}

{% block title %}Crear Ubicación{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Crear Ubicación</h3>
                </div>
                <div class="card-body">
                    <form id="locationForm" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Dirección</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="address" name="address" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="searchAddress()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="latitude" class="form-label">Latitud</label>
                                            <input type="number" step="any" class="form-control" id="latitude" name="latitude" required readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="longitude" class="form-label">Longitud</label>
                                            <input type="number" step="any" class="form-control" id="longitude" name="longitude" required readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="map" style="height: 400px;"></div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">Guardar</button>
                                <a href="{{ url_for('location.index') }}" class="btn btn-secondary">Cancelar</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let map;
let marker;
const geocoder = L.Control.Geocoder.nominatim();

function initMap() {
    // Coordenadas iniciales (centro de la ciudad)
    const initialLocation = [-34.6037, -58.3816];
    
    // Inicializar mapa
    map = L.map('map').setView(initialLocation, 13);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Agregar marcador inicial
    marker = L.marker(initialLocation, {
        draggable: true
    }).addTo(map);
    
    // Actualizar coordenadas cuando se mueve el marcador
    marker.on('dragend', function(e) {
        const position = marker.getLatLng();
        updateCoordinates(position.lat, position.lng);
        
        // Obtener dirección desde coordenadas
        geocoder.reverse(position, map.options.crs.scale(map.getZoom()), results => {
            if (results && results.length > 0) {
                document.getElementById('address').value = results[0].name;
            }
        });
    });
    
    // Permitir hacer clic en el mapa para mover el marcador
    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        updateCoordinates(e.latlng.lat, e.latlng.lng);
        
        // Obtener dirección desde coordenadas
        geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), results => {
            if (results && results.length > 0) {
                document.getElementById('address').value = results[0].name;
            }
        });
    });
}

function updateCoordinates(lat, lng) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
}

function searchAddress() {
    const address = document.getElementById('address').value;
    if (!address) return;
    
    geocoder.geocode(address, results => {
        if (results && results.length > 0) {
            const result = results[0];
            const latlng = result.center;
            
            map.setView(latlng, 16);
            marker.setLatLng(latlng);
            updateCoordinates(latlng.lat, latlng.lng);
        }
    });
}

// Inicializar mapa cuando se carga la página
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %} 