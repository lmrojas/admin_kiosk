{% extends "base.html" %}

{% block title %}Kioscos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<style>
    .kiosk-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; }
    
    .metric-badge {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
    }
    
    .table th {
        white-space: nowrap;
    }
    
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .filter-card {
        transition: all 0.3s ease;
    }
    .filter-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Kioscos</h1>
            <p class="text-muted">Total: {{ kiosks|length }} kioscos</p>
        </div>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKioskModal">
                <i class="fas fa-plus me-1"></i>Agregar Kiosk
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card filter-card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Estado</h6>
                    <div class="form-check">
                        <input class="form-check-input filter-status" type="checkbox" value="online" id="filterOnline" checked>
                        <label class="form-check-label" for="filterOnline">
                            <span class="kiosk-status status-online"></span>Online
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-status" type="checkbox" value="offline" id="filterOffline" checked>
                        <label class="form-check-label" for="filterOffline">
                            <span class="kiosk-status status-offline"></span>Offline
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-status" type="checkbox" value="warning" id="filterWarning" checked>
                        <label class="form-check-label" for="filterWarning">
                            <span class="kiosk-status status-warning"></span>Advertencia
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card filter-card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Ubicación</h6>
                    <select class="form-select" id="locationFilter">
                        <option value="">Todas las ubicaciones</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">{{ location.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card filter-card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Alertas</h6>
                    <select class="form-select" id="alertFilter">
                        <option value="">Todos los niveles</option>
                        <option value="none">Sin alertas</option>
                        <option value="low">Bajo</option>
                        <option value="medium">Medio</option>
                        <option value="high">Alto</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card filter-card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Búsqueda</h6>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Buscar por nombre o serial...">
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Kioscos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="kiosksTable">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Nombre</th>
                            <th>Serial</th>
                            <th>Ubicación</th>
                            <th>IP</th>
                            <th>CPU</th>
                            <th>RAM</th>
                            <th>Disco</th>
                            <th>Temperatura</th>
                            <th>Última Conexión</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kiosk in kiosks %}
                            <tr data-kiosk-id="{{ kiosk.id }}" 
                                data-status="{{ kiosk.status }}"
                                data-location="{{ kiosk.location.id if kiosk.location else '' }}"
                                data-alert-level="{{ kiosk.alert_level }}">
                                <td>
                                    <span class="kiosk-status status-{{ kiosk.status }}"></span>
                                    {{ kiosk.status|title }}
                                </td>
                                <td>
                                    <a href="{{ url_for('kiosk.detail', id=kiosk.id) }}">
                                        {{ kiosk.name }}
                                    </a>
                                </td>
                                <td>{{ kiosk.serial_number }}</td>
                                <td>
                                    {% if kiosk.location %}
                                        {{ kiosk.location.name }}
                                    {% else %}
                                        <span class="text-muted">No asignada</span>
                                    {% endif %}
                                </td>
                                <td>{{ kiosk.ip_address or 'N/A' }}</td>
                                <td>
                                    {% set cpu = kiosk.sensors_data_dict.cpu_usage|default(0)|float %}
                                    <span class="badge metric-badge bg-{{ 'danger' if cpu > 90 else 'warning' if cpu > 80 else 'success' }}">
                                        {{ "%.1f"|format(cpu) }}%
                                    </span>
                                </td>
                                <td>
                                    {% set ram = kiosk.sensors_data_dict.ram_usage|default(0)|float %}
                                    <span class="badge metric-badge bg-{{ 'danger' if ram > 95 else 'warning' if ram > 85 else 'success' }}">
                                        {{ "%.1f"|format(ram) }}%
                                    </span>
                                </td>
                                <td>
                                    {% set disk = kiosk.sensors_data_dict.disk_usage|default(0)|float %}
                                    <span class="badge metric-badge bg-{{ 'danger' if disk > 95 else 'warning' if disk > 85 else 'success' }}">
                                        {{ "%.1f"|format(disk) }}%
                                    </span>
                                </td>
                                <td>
                                    {% set temp = kiosk.sensors_data_dict.temperature|default(0)|float %}
                                    <span class="badge metric-badge bg-{{ 'danger' if temp > 40 else 'warning' if temp > 35 else 'success' }}">
                                        {{ "%.1f"|format(temp) }}°C
                                    </span>
                                </td>
                                <td>{{ kiosk.last_connection.strftime('%d/%m/%Y %H:%M:%S') if kiosk.last_connection else 'Nunca' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('kiosk.detail', id=kiosk.id) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-secondary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#assignLocationModal"
                                                data-kiosk-id="{{ kiosk.id }}"
                                                title="Asignar ubicación">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="deleteKiosk('{{ kiosk.id }}')"
                                                title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Kiosk -->
<div class="modal fade" id="addKioskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Kiosk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addKioskForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="serial_number" class="form-label">Número de Serie</label>
                        <input type="text" class="form-control" id="serial_number" name="serial_number" required>
                    </div>
                    <div class="mb-3">
                        <label for="location_id" class="form-label">Ubicación</label>
                        <select class="form-select" id="location_id" name="location_id">
                            <option value="">Seleccionar ubicación...</option>
                            {% for location in locations %}
                                <option value="{{ location.id }}">{{ location.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveKioskBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar Ubicación -->
<div class="modal fade" id="assignLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Ubicación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignLocationForm">
                    <input type="hidden" id="assign_kiosk_id" name="kiosk_id">
                    <div class="mb-3">
                        <label for="assign_location_id" class="form-label">Ubicación</label>
                        <select class="form-select" id="assign_location_id" name="location_id" required>
                            <option value="">Seleccionar ubicación...</option>
                            {% for location in locations %}
                                <option value="{{ location.id }}">{{ location.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveLocationBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    // Inicializar DataTable
    const table = $('#kiosksTable').DataTable({
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
        },
        order: [[0, 'asc']],
        pageLength: 25,
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
    });
    
    // WebSocket para actualizaciones en tiempo real
    const socket = io();
    
    socket.on('connect', function() {
        console.log('Conectado al servidor WebSocket');
    });
    
    socket.on('kiosk_update', function(data) {
        const row = $(`tr[data-kiosk-id="${data.kiosk_id}"]`);
        if (row.length) {
            location.reload();
        }
    });
    
    // Filtros personalizados
    $('.filter-status').on('change', function() {
        const checkedStatuses = $('.filter-status:checked').map(function() {
            return $(this).val();
        }).get();
        
        table.column(0).search(checkedStatuses.join('|'), true, false).draw();
    });
    
    $('#locationFilter').on('change', function() {
        const locationId = $(this).val();
        if (locationId) {
            table.column(3).search(locationId).draw();
        } else {
            table.column(3).search('').draw();
        }
    });
    
    $('#alertFilter').on('change', function() {
        const alertLevel = $(this).val();
        if (alertLevel) {
            $('tr').show();
            $('tr').not(`[data-alert-level="${alertLevel}"]`).hide();
        } else {
            $('tr').show();
        }
    });
    
    $('#searchFilter').on('keyup', function() {
        table.search(this.value).draw();
    });
    
    // Agregar nuevo kiosk
    $('#saveKioskBtn').click(function() {
        const formData = {
            name: $('#name').val(),
            serial_number: $('#serial_number').val(),
            location_id: $('#location_id').val() || null
        };
        
        $.ajax({
            url: '/kiosk/api/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                showNotification('success', 'Kiosk agregado exitosamente');
                $('#addKioskModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                const message = xhr.responseJSON ? xhr.responseJSON.message : 'Error al agregar el kiosk';
                showNotification('danger', message);
            }
        });
    });
    
    // Asignar ubicación
    $('#assignLocationModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const kioskId = button.data('kiosk-id');
        $('#assign_kiosk_id').val(kioskId);
    });
    
    $('#saveLocationBtn').click(function() {
        const formData = {
            kiosk_id: $('#assign_kiosk_id').val(),
            location_id: $('#assign_location_id').val()
        };
        
        $.ajax({
            url: '/location/api/assign-kiosk',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                showNotification('success', 'Ubicación asignada exitosamente');
                $('#assignLocationModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                const message = xhr.responseJSON ? xhr.responseJSON.message : 'Error al asignar la ubicación';
                showNotification('danger', message);
            }
        });
    });
});

function deleteKiosk(kioskId) {
    if (confirm('¿Está seguro que desea eliminar este kiosk?')) {
        $.ajax({
            url: `/kiosk/api/delete/${kioskId}`,
            method: 'DELETE',
            success: function(response) {
                showNotification('success', 'Kiosk eliminado exitosamente');
                location.reload();
            },
            error: function(xhr) {
                const message = xhr.responseJSON ? xhr.responseJSON.message : 'Error al eliminar el kiosk';
                showNotification('danger', message);
            }
        });
    }
}

function showNotification(type, message) {
    const alert = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`);
    $('.container-fluid').prepend(alert);
    
    setTimeout(() => {
        alert.alert('close');
    }, 5000);
}
</script>
{% endblock %} 